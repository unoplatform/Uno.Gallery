steps:
- checkout: self
  clean: true
  fetchDepth: 0
  persistCredentials: true

- template: templates/gitversion.yml
- template: templates/dotnet-install-windows.yml
- template: templates/canary-updater.yml

- bash: |
    dotnet build Uno.Gallery/Uno.Gallery.csproj \
      -p:TargetFrameworkOverride=net9.0-desktop \
      -c Release \
      -p:InformationalVersion=$(NBGV_InformationalVersion) \
      -bl:$(Build.ArtifactStagingDirectory)/build.binlog

- task: CopyFiles@2
  displayName: Copy Skia output
  inputs:
    SourceFolder: Uno.Gallery/bin/Release/net9.0-desktop
    Contents: '**/*.*'
    TargetFolder: $(Build.ArtifactStagingDirectory)/bin

- script: |
    du -sh --block-size=1M $(Build.ArtifactStagingDirectory)/bin
  displayName: Log bin folder size

- bash: |
    bin_path="$(Build.ArtifactStagingDirectory)/bin"
    folder_size=$(du -sh --block-size=1M "$bin_path" | cut -f1)
    timestamp=$(date +"%T")

    mkdir -p "$bin_path"

    touch "$bin_path/metrics.json"
    
    cat <<EOF > "$bin_path/metrics.json"
    {
      "buildId": "$(Build.BuildId)",
      "commit": "$(Build.SourceVersion)",
      "size": "${folder_size}",
      "isTrimmed": false,
      "timeStamp": "${timestamp}"
    }
    EOF
  displayName: Add metrics to artifact (JSON)



- task: PublishBuildArtifacts@1
  displayName: Publish desktop artifacts
  retryCountOnTaskFailure: 3
  inputs:
    pathToPublish: $(Build.ArtifactStagingDirectory)/bin
    ArtifactName: desktop
