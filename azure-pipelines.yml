variables:
  IsLightBuild: $[eq(variables['Build.Reason'], 'PullRequest')]
  IsCanaryBranch: $[startsWith(variables['Build.SourceBranch'], 'refs/heads/canaries/')]
  ANDROID_NDK_HOME: C:\Microsoft\AndroidNDK64\android-ndk-r16b
  ANDROID_NDK_PATH: C:\Microsoft\AndroidNDK64\android-ndk-r16b
  AndroidNdkDirectory: C:\Microsoft\AndroidNDK64\android-ndk-r16b
  
jobs:
- job: Windows
  strategy:
    maxParallel: 3
    matrix:
      Android_Store:
        ApplicationPlatform: AnyCPU
        ArtifactName: Android
        TemplatePath: build/stage-build-android-xamarin.yml
      Android_AppCenter:
        ApplicationPlatform: AnyCPU
        ArtifactName: Android
        BuildForPlayStore: False
        VersionCodeOffset: 400050
        TemplatePath: build/stage-build-android-xamarin.yml
      SkiaGTK:
        ApplicationPlatform: AnyCPU
        ArtifactName: SkiaGTK
        TemplatePath: build/stage-build-skia-gtk.yml
      UWP:
        ApplicationPlatform: x64
        ArtifactName: UWP
        VersionCodeOffset: 50
        TemplatePath: build/stage-build-uwp.yml

  pool:
    vmImage: windows-2019
    
  variables:
  - group: 'UADO Keystore' # Import all variables for the signing from the library in azure devops

  steps:
    - template: $(TemplatePath)

- job: macOS
  strategy:
    maxParallel: 2
    matrix:
      iOS:
        ApplicationPlatform: iPhone
        ArtifactName: iOS
        VersionCodeOffset: 50
        TemplatePath: build/stage-build-ios-xamarin.yml
      macOS:
        ApplicationPlatform: iPhoneSimulator
        ArtifactName: macOS
        VersionCodeOffset: 50
        TemplatePath: build/stage-build-macOS-xamarin.yml
  pool:
    vmImage: macOS-10.15
    
  variables:
  - name: SkipUnknownFrameworks
    value: true # Used by TargetFrameworks.Filtering package
  - group: unoplatform.apple.ios.appstore.distribution

  steps:
  - task: InstallAppleCertificate@2
    displayName: Install Certificate
    inputs:
      certSecureFile: UnoPlatform-Apple-Distribution.p12
      certPwd: $(appleappstorecertificatepassword)
      keychain: temp
      deleteCert: true

  - task: InstallAppleCertificate@2
    displayName: Install Certificate
    inputs:
      certSecureFile: UnoPlatform-MacInstaller.p12
      certPwd: $(appleappstorecertificatepassword)
      keychain: temp
      deleteCert: true

  - task: InstallAppleProvisioningProfile@1
    displayName: 'Install Apple Provisioning Profile'
    inputs:
      provisioningProfileLocation: 'secureFiles'
      provProfileSecureFile: Uno_Gallery_Canary_Catalyst.provisionprofile

  - task: InstallAppleProvisioningProfile@1
    displayName: 'Install Apple Provisioning Profile'
    inputs:
      provisioningProfileLocation: 'secureFiles'
      provProfileSecureFile: Uno_Gallery_Canary_iOS.mobileprovision

  - template: build/templates/set-app-versions.yml
  - template: $(TemplatePath)

- job: macOS_net6
  strategy:
    maxParallel: 2
    matrix:
      iOS:
        BuildTargetFramework: net6.0-ios
        ArtifactName: iOS-mobile
        ApplicationBuildNumberOffset: 50
        BuildCommand: publish
      Catalyst:
        BuildTargetFramework: net6.0-maccatalyst
        ArtifactName: Catalyst
        ApplicationBuildNumberOffset: 50
        BuildCommand: build
  pool:
    vmImage: macOS-11
    
  variables:
  - name: SkipUnknownFrameworks
    value: true # Used by TargetFrameworks.Filtering package
  - group: unoplatform.apple.ios.appstore.distribution

  steps:
  - task: InstallAppleCertificate@2
    displayName: Install Certificate
    inputs:
      certSecureFile: UnoPlatform-Apple-Distribution.p12
      certPwd: $(appleappstorecertificatepassword)
      keychain: temp
      deleteCert: true

  - task: InstallAppleCertificate@2
    displayName: Install Certificate
    inputs:
      certSecureFile: UnoPlatform-MacInstaller.p12
      certPwd: $(appleappstorecertificatepassword)
      keychain: temp
      deleteCert: true

  - task: InstallAppleProvisioningProfile@1
    displayName: 'Install Apple Provisioning Profile'
    inputs:
      provisioningProfileLocation: 'secureFiles'
      provProfileSecureFile: Uno_Gallery_Canary_Catalyst.provisionprofile

  - task: InstallAppleProvisioningProfile@1
    displayName: 'Install Apple Provisioning Profile'
    inputs:
      provisioningProfileLocation: 'secureFiles'
      provProfileSecureFile: Uno_Gallery_Canary_iOS.mobileprovision

  - template: build/templates/set-app-versions.yml
  - template: build/stage-build-mobile.yml

- job: Linux
  timeoutInMinutes: 90
  pool:
    vmImage: ubuntu-18.04
  
  container: unoplatform/wasm-build:3.0

  variables:
    ArtifactName: WASM
    SkipUnknownFrameworks: true

  steps:
    - template: build/templates/set-app-versions.yml
    - template: build/stage-build-wasm.yml

- template: build/stage-uitests-wasm.yml
- template: build/stage-uitests-ios.yml
- template: build/stage-uitests-android.yml
